<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Social Map Nomadi — Demo (patched)</title>

  <!-- PWA / Icon metadata -->
  <link rel="manifest" href="/manifest.json">
  <link rel="icon" href="/favicon.ico" type="image/x-icon">
  <link rel="icon" href="/icons/logo.svg" type="image/svg+xml">
  <link rel="icon" type="image/png" sizes="32x32" href="/icons/icon-32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/icons/icon-16.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/icons/icon-512.png">
  <meta name="theme-color" content="#27AE60">

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

  <!-- Supabase UMD (client) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.js"></script>

  <style>
    :root{--bg:#FFF7EE;--card:#fff;--muted:#7B8A86;--accent:#FF6B35;--accent-alt:#FFC857}
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,Arial,Helvetica,sans-serif;background:var(--bg);color:#032B3A}
    .app{display:grid;grid-template-columns:320px 1fr 360px;gap:12px;height:100vh;padding:12px}
    .panel{background:var(--card);border-radius:10px;padding:12px;box-shadow:0 8px 24px rgba(2,6,23,0.06);overflow:auto}
    .small{font-size:.88rem;color:var(--muted)}
    .btn{padding:8px 10px;border-radius:8px;border:0;cursor:pointer}
    .btn-outline{background:transparent;border:1px solid #e6eef2;padding:6px 8px;border-radius:8px}
    .btn-primary{background:linear-gradient(90deg,var(--accent),var(--accent-alt));color:#022;padding:8px 10px;border-radius:8px}
    .card{background:#fff;border-radius:8px;padding:10px;border:1px solid #eef2f6;margin-bottom:10px}
    .chat-window{height:30vh;overflow:auto;padding:8px;background:#fff;border-radius:8px;border:1px solid #eef2f6;margin-bottom:8px}
    #map{height:56vh;border-radius:10px;box-shadow:0 12px 40px rgba(2,6,23,0.08)}
    .row{display:flex;gap:8px}
    input, select, textarea{padding:8px;border-radius:8px;border:1px solid #e6eef2}
    .modal-bg{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.45);z-index:2000}
    .modal-bg.show{display:flex}
    .modal{background:#fff;padding:16px;border-radius:10px;min-width:320px;max-width:720px}
    .note{font-size:.85rem;color:var(--muted);margin-top:6px}
    .result-card{background:#fff;padding:8px;border-radius:8px;border:1px solid #eef2f6;margin-top:8px}
    button.user-link{background:transparent;border:0;color:#045;cursor:pointer;font-weight:700}
    #offlineBanner{position:fixed;left:12px;right:12px;bottom:12px;padding:10px;border-radius:10px;background:#fff3f3;color:#7b2d2d;border:1px solid #ffd6d6;display:none;z-index:4000;box-shadow:0 8px 24px rgba(2,6,23,0.06)}
    #pwaInstallBtn{display:none}
    @media(max-width:1000px){ .app{grid-template-columns:1fr;grid-auto-rows:auto} #map{height:320px} }
  </style>
</head>
<body>
  <!-- Offline indicator / PWA install control -->
  <div id="offlineBanner" role="status">Sei offline — alcune funzioni potrebbero non essere disponibili.</div>

  <div class="app">
    <!-- LEFT -->
    <aside class="panel">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <strong>Gruppi città</strong>
          <div class="small">Crea, iscriviti e partecipa</div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <div id="accountBox" class="small">Account: You</div>
          <button id="btnSubscribe" class="btn-outline">Abbonati (demo)</button>
          <button id="btnNewGroup" class="btn-primary">+ Nuovo</button>
          <!-- PWA Install button (shown when beforeinstallprompt fires) -->
          <button id="btnInstall" class="btn-outline" style="display:none" title="Installa app">Installa</button>
        </div>
      </div>

      <div style="margin-top:12px">
        <div class="small">Filtra per città</div>
        <select id="filterCity" style="margin-top:8px;width:100%"></select>
      </div>

      <div id="groupsList" style="margin-top:12px;max-height:62vh;overflow:auto"></div>
    </aside>

    <!-- CENTER -->
    <main class="panel">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <div id="centerTitle" style="font-weight:700">Chat: Globale</div>
          <div id="centerSubtitle" class="small">Seleziona chat globale, di gruppo o privata</div>
        </div>
        <div style="display:flex;gap:8px">
          <button id="btnOpenMap" class="btn-outline">Apri mappa</button>
          <button id="btnJoin" class="btn-primary" style="display:none">Iscriviti</button>
          <button id="btnLeave" class="btn-outline" style="display:none">Lascia</button>
        </div>
      </div>

      <div style="display:grid;grid-template-columns:1fr 360px;gap:12px;margin-top:12px">
        <section>
          <div class="chat-window" id="groupChat"></div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <input id="chatInput" placeholder="Scrivi nella chat attiva..." />
            <button id="chatSend" class="btn-primary">Invia</button>
            <button id="btnSwitchGlobal" class="btn-outline" title="Vai alla chat globale">Globale</button>
          </div>

          <div class="card" style="margin-top:12px">
            <strong>Post nel gruppo</strong>
            <textarea id="postText" rows="3" style="margin-top:8px;width:100%"></textarea>
            <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
              <label class="btn-outline" style="padding:6px;cursor:pointer"><input id="postFile" type="file" accept="image/*,video/*" style="display:none"/>Carica file</label>
              <button id="postAttachPos" class="btn-outline">Allega posizione</button>
              <label style="margin-left:auto"><input id="postCross" type="checkbox"/> Condividi in Globale</label>
              <button id="postPublish" class="btn-primary">Pubblica</button>
            </div>
            <div id="postInfo" class="small" style="margin-top:8px;color:var(--muted)"></div>
          </div>

          <div class="card" style="margin-top:12px">
            <strong>Crea percorso</strong>
            <div class="row" style="margin-top:8px">
              <input id="from" placeholder="Partenza (e.g. Milano)"/>
              <input id="to" placeholder="Arrivo (e.g. Roma)"/>
            </div>
            <div class="row" style="margin-top:8px">
              <select id="mode">
                <option value="driving-car">Auto</option>
                <option value="public-transport">Pubblico</option>
                <option value="cycling-regular">Bici</option>
                <option value="foot-walking">A piedi</option>
                <option value="eco">Eco</option>
              </select>
              <button id="btnRoute" class="btn-primary">Calcola</button>
            </div>
            <div id="routeInfo" class="small" style="margin-top:8px;color:var(--muted)"></div>
          </div>
        </section>

        <aside>
          <div style="font-weight:700">Mappa</div>
          <div id="map" style="margin-top:8px"></div>

          <div class="card" style="margin-top:12px">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <strong>Prenotazione rapida</strong>
              <div class="small">Demo</div>
            </div>

            <div class="filters-row" style="margin-top:8px">
              <select id="quickCity" style="width:100%"><option value="">Tutte le città</option></select>
              <select id="quickType" style="width:100%"><option value="">Tutti</option><option value="hotel">Hotel</option><option value="hostel">Ostello</option><option value="coworking">Coworking</option></select>
              <select id="quickPriceFilter" style="width:100%"><option value="">Tutti i prezzi</option><option value="cheap">&lt; 20€</option><option value="budget">20-40€</option><option value="premium">&gt; 40€</option></select>
            </div>

            <div style="display:flex;gap:8px;margin-top:8px;align-items:center">
              <button id="quickSearch" class="btn-primary" style="flex:0 0 auto">Cerca</button>
              <div id="quickSearchNote" class="note">Premi "Cerca" per visualizzare le strutture.</div>
            </div>

            <select id="quickStructure" style="margin-top:8px;width:100%"></select>
            <div id="quickResults" class="results-list"></div>

            <input id="quickDate" type="date" style="margin-top:8px;width:100%"/>
            <input id="quickName" placeholder="Tuo nome" style="margin-top:8px;width:100%"/>
            <div style="display:flex;gap:8px;margin-top:8px">
              <button id="quickBook" class="btn-primary">Prenota</button>
              <div id="quickMsg" class="small" style="align-self:center;color:var(--muted)"></div>
            </div>
            <div style="margin-top:10px"><strong>Prenotazioni demo</strong><div id="bookings" class="small" style="margin-top:6px;color:var(--muted)">Nessuna prenotazione</div></div>
          </div>
        </aside>
      </div>
    </main>

    <!-- RIGHT -->
    <aside class="panel">
      <div><strong>Profili</strong><div class="small">Visualizza o apri chat privata</div></div>
      <div id="profiles" style="margin-top:12px"></div>
      <div style="margin-top:12px"><div style="font-weight:700">Feed Globale</div><div id="globalFeed" style="margin-top:8px;max-height:40vh;overflow:auto"></div></div>
    </aside>
  </div>

  <!-- Modal markup (reusable) -->
  <div class="modal-bg" id="modalGroup" aria-hidden="true">
    <div class="modal">
      <strong>Nuovo gruppo</strong>
      <div style="margin-top:8px">
        <input id="gName" placeholder="Nome gruppo" />
        <input id="gCity" placeholder="Città" style="margin-top:8px"/>
        <textarea id="gDesc" rows="3" placeholder="Descrizione" style="margin-top:8px"></textarea>
        <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
          <button id="gCancel" class="btn-outline">Annulla</button>
          <button id="gSave" class="btn-primary">Crea</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Leaflet -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <script>
  // Short helper
  window.$ = id => document.getElementById(id);

  (function(){
    "use strict";

    /* ---------- Supabase config (DO NOT COMMIT KEYS) ----------
       Replace the placeholder key at build time or inject via server.
       If you do not set a valid key, the app will run in "local demo" mode
       (uses localStorage) and Supabase calls will be skipped.
    */
    const SUPABASE_URL = "https://lqktkipfvcvjcgixzfmn.supabase.co";
    const SUPABASE_KEY = "REPLACE_WITH_ANON_KEY_AT_BUILD_TIME"; // <<<<-- replace during deploy
    let sb_local = null;
    try {
      if(typeof SUPABASE_KEY === 'string' && SUPABASE_KEY.indexOf('REPLACE_') === -1 && window.supabase && window.supabase.createClient){
        sb_local = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
      }
    } catch(e){ console.warn('Supabase init error', e); }
    if(sb_local) window.sb = sb_local; else window.sb = undefined;

    /* ---------- Utilities ---------- */
    const now = () => new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
    const uid = (p='x') => p + Date.now().toString(36).slice(3) + Math.random().toString(36).slice(2,6);
    const escapeHtml = s => String(s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#39;');

    /* ---------- Storage + upload helpers (improved) ---------- */
    const STORAGE_BUCKET = 'uploads'; // create this bucket in Supabase
    const MAX_UPLOAD_BYTES = 10 * 1024 * 1024; // 10MB limit (adjust)
    const ACCEPTED_MIMES = ['image/jpeg','image/png','image/webp','image/gif','video/mp4','video/webm','video/ogg'];

    async function uploadFileToStorage(file){
      if(!window.sb || !window.sb.storage) throw new Error('Supabase storage non disponibile');
      if(!file || typeof file.size !== 'number') throw new Error('File non valido');

      if(file.size > MAX_UPLOAD_BYTES) throw new Error('File troppo grande. Max ' + (MAX_UPLOAD_BYTES/1024/1024) + 'MB');
      if(ACCEPTED_MIMES.length && !ACCEPTED_MIMES.includes(file.type)) {
        // optionally allow by extension, but safer to block unknown types
        throw new Error('Tipo file non supportato: ' + file.type);
      }

      const ext = (file.name || '').split('.').pop() || '';
      const path = `chat/${uid('f')}.${ext || 'bin'}`;
      const { data, error } = await window.sb.storage.from(STORAGE_BUCKET).upload(path, file, { cacheControl: '3600', upsert: false });
      if(error){
        console.error('Storage.upload error', error);
        throw error;
      }
      // get public url (works if bucket is public)
      const { data: pub, error: pubErr } = window.sb.storage.from(STORAGE_BUCKET).getPublicUrl(path);
      if(pubErr) console.warn('getPublicUrl error', pubErr);
      const publicUrl = pub && pub.publicUrl ? pub.publicUrl : null;
      return { path, url: publicUrl };
    }

    async function getFilePublicUrl(path){
      if(!window.sb || !window.sb.storage) return null;
      try {
        const { data, error } = window.sb.storage.from(STORAGE_BUCKET).getPublicUrl(path);
        if(error) { console.warn('getPublicUrl error', error); return null; }
        return data.publicUrl || null;
      } catch(e){ console.warn(e); return null; }
    }

    /* ---------- Safe serializer (unchanged) ---------- */
    function safeForInsert(obj){
      try { return JSON.parse(JSON.stringify(obj)); }
      catch(e){
        function strip(v){
          if(Array.isArray(v)) return v.map(strip);
          if(v && typeof v === 'object'){
            const out = {};
            Object.keys(v).forEach(k=>{
              const val = v[k];
              if(val === null) out[k]=null;
              else if(typeof val === 'string' || typeof val === 'number' || typeof val === 'boolean') out[k]=val;
              else if(Array.isArray(val)) out[k]=strip(val);
              else if(val && typeof val === 'object'){
                const simple = {};
                Object.keys(val).forEach(kk=>{
                  const vv = val[kk];
                  if(vv === null || typeof vv === 'string' || typeof vv === 'number' || typeof vv === 'boolean' || Array.isArray(vv)) simple[kk]=strip(vv);
                });
                if(Object.keys(simple).length) out[k]=simple;
              }
            });
            return out;
          }
          return v;
        }
        return strip(obj);
      }
    }

    /* ---------- Supabase wrappers (with logging) ---------- */
    async function supabaseInsert(table, payload) {
      if(!window.sb) return { data:null, error: new Error('Supabase client not initialized') };
      const safePayload = Array.isArray(payload) ? payload.map(p=>safeForInsert(p)) : safeForInsert(payload);
      try {
        const { data, error } = await window.sb.from(table).insert(Array.isArray(safePayload) ? safePayload : [safePayload]);
        if(error){ console.warn('Supabase insert error', table, error, 'payload:', safePayload); }
        return { data, error };
      } catch(e) { console.error('Supabase insert exception', table, e, 'payload:', safePayload); return { data:null, error: e }; }
    }
    async function supabaseSelect(table){ if(!window.sb) return null; try{ const { data, error } = await window.sb.from(table).select('*'); if(error){ console.warn('Supabase select error', table, error); return null; } return data; }catch(e){ console.warn('Supabase select exception', e); return null; } }

    /* ---------- App state (kept compatible) ---------- */
    const ME = { id:'you', name:'You' };
    const K_GROUPS='smn_groups_v1', K_GROUP_MEMBERS='smn_group_members_v1', K_CHATS='smn_chats_v1', K_UPLOADS='smn_uploads_v1', K_PROFILES='smn_profiles_v1', K_BOOKS='smn_books_v1', K_PREMIUM='smn_premium_v1', K_FOLLOWS='smn_follows_v1';
    const load = (k,f)=>{ try{ return JSON.parse(localStorage.getItem(k)||'null')||f; }catch(e){return f;} };
    const save = (k,v)=>{ try{ localStorage.setItem(k,JSON.stringify(v)); }catch(e){} };

    let GROUPS = load(K_GROUPS, null);
    if(!GROUPS){
      GROUPS = [
        { id:'g_mi_nomadi', name:'Nomadi Milano', city:'Milano', desc:'Incontri, coworking, eventi' },
        { id:'g_fi_foto', name:'Fotografi Firenze', city:'Firenze', desc:'Uscite fotografiche' }
      ];
      save(K_GROUPS, GROUPS);
      GROUPS.forEach(g=>{ if(window.sb) supabaseInsert('smn_groups_v1',{ id:g.id, name:g.name, city:g.city, "desc":g.desc, created_at:new Date().toISOString() }); });
    }
    let GROUP_MEMBERS = load(K_GROUP_MEMBERS, {});
    GROUPS.forEach(g=>{ GROUP_MEMBERS[g.id]=GROUP_MEMBERS[g.id]||{}; GROUP_MEMBERS[g.id][ME.id]=GROUP_MEMBERS[g.id][ME.id]||false; });

    let CHATS = load(K_CHATS, { global:[ { user:'System', txt:'Benvenuto (demo)', time: now() } ] });
    let UPLOADS = load(K_UPLOADS, []);
    let PROFILES = load(K_PROFILES, [
      { id:'p1', name:'Anna Conte', job:'UX Designer', city:'Milano', bio:'Amo il design e il caffè.' },
      { id:'p2', name:'Luca Bianchi', job:'Frontend Dev', city:'Milano', bio:'React, mappe e pizza.' },
      { id:'p3', name:'Giulia Moretti', job:'Photographer', city:'Firenze', bio:'Fotografa freelance.' }
    ]);
    let BOOKS = load(K_BOOKS, []);
    let PREMIUM = load(K_PREMIUM, { active:false });
    let FOLLOWS = load(K_FOLLOWS, {});

    const STRUCTURES = [
      { id:'h_mi_1', nome:'Milan Budget', tipo:'hotel', citta:'Milano', prezzo_da:35 },
      { id:'c_mi_1', nome:'Cowork Milano Centro', tipo:'coworking', citta:'Milano', prezzo_da:15 },
      { id:'h_na_1', nome:'Napoli Hostel', tipo:'hostel', citta:'Napoli', prezzo_da:18 },
      { id:'h_rm_1', nome:'Roma Affordable', tipo:'hotel', citta:'Roma', prezzo_da:45 },
      { id:'c_fi_1', nome:'Photowork Firenze', tipo:'coworking', citta:'Firenze', prezzo_da:20 },
      { id:'h_fi_1', nome:'Florence Backpackers', tipo:'hostel', citta:'Firenze', prezzo_da:28 }
    ];

    const CITY_COORDS = { Milano:[45.4654,9.1866], Firenze:[43.7696,11.2558], Roma:[41.9028,12.4964], Napoli:[40.8518,14.2681] };
    const CITY_INFO = {
      Milano:{ nomads:1284, coworkings:[{name:'Cowork Milano Centro',seats:42}], cheapHotel:{name:'Milan Budget',priceFrom:35}, event:{title:'Digital Nomads Meetup',date:'2025-12-20',desc:'Aperitivo',link:'#'} },
      Firenze:{ nomads:430, coworkings:[{name:'Photowork Firenze',seats:24}], cheapHotel:{name:'Florence Backpackers',priceFrom:28}, event:{title:'Foto & Coding Camp',date:'2025-12-18',desc:'Workshop',link:'#'} },
      Roma:{ nomads:980, coworkings:[{name:'Roma Hub',seats:60}], cheapHotel:{name:'Roma Hostel',priceFrom:30}, event:{title:'Remote Work Summit',date:'2025-12-22',desc:'Panel',link:'#'} },
      Napoli:{ nomads:210, coworkings:[{name:'Napoli Cowork',seats:14}], cheapHotel:{name:'Napoli Hostel',priceFrom:18}, event:{title:'Sea & Code',date:'2025-12-19',desc:'Weekend',link:'#'} }
    };

    /* ---------- Map & runtime flags ---------- */
    let map=null, markersLayer=null, routeLayer=null, previewMarkers=[], highlightMarker=null, highlightTimeout=null;
    let activeChat={type:'global',id:null}, pendingFile=null, pendingPos=null, selectedGroup=null, bookingCandidate=null, quickSearchPerformed=false;

    /* ---------- UI helpers ---------- */
    function showModal(id){ const el = $(id); if(!el) return; el.classList.add('show'); el.setAttribute('aria-hidden','false'); }
    function hideModal(id){ const el = $(id); if(!el) return; el.classList.remove('show'); el.setAttribute('aria-hidden','true'); }

    function setActiveChat(chat){
      activeChat = chat || { type:'global', id:null };
      try {
        if(activeChat.type==='global'){
          if($('centerTitle')) $('centerTitle').textContent='Chat: Globale';
          if($('centerSubtitle')) $('centerSubtitle').textContent='Tutti gli utenti';
        } else if(activeChat.type==='group'){
          const g = GROUPS.find(x=>x.id===activeChat.id);
          if($('centerTitle')) $('centerTitle').textContent = g?`Gruppo: ${g.name}`:'Gruppo';
          if($('centerSubtitle')) $('centerSubtitle').textContent = g?`${g.city} · ${g.desc||''}`:'';
          if(g){ selectedGroup = g.id; updateJoinButtons && updateJoinButtons(); }
        } else if(activeChat.type==='private'){
          const p = PROFILES.find(x=>x.id===activeChat.id||x.name===activeChat.id);
          if(p){ if($('centerTitle')) $('centerTitle').textContent=`Chat privata: ${p.name}`; if($('centerSubtitle')) $('centerSubtitle').textContent=p.job?`${p.job} · ${p.city||''}`:`${p.city||''}`; }
          else { if($('centerTitle')) $('centerTitle').textContent=`Chat privata: ${activeChat.id}`; if($('centerSubtitle')) $('centerSubtitle').textContent='Chat diretta'; }
        } else {
          if($('centerTitle')) $('centerTitle').textContent='Chat';
          if($('centerSubtitle')) $('centerSubtitle').textContent='';
        }
      } catch(e){ console.warn('setActiveChat error', e); }
      try { renderActiveChat && renderActiveChat(); } catch(e){ console.warn('renderActiveChat error', e); }
      try { updateJoinButtons && updateJoinButtons(); } catch(e){}
    }

    /* ---------- Rendering & helpers (kept similar) ---------- */
    function renderProfiles(){
      const wrap=$('profiles'); if(!wrap) return; wrap.innerHTML='';
      (PROFILES||[]).forEach(p=>{
        const el=document.createElement('div'); el.className='card';
        el.innerHTML=`<div style="font-weight:700">${escapeHtml(p.name)}</div><div class="small">${escapeHtml(p.job||'')} · ${escapeHtml(p.city||'')}</div><div style="margin-top:8px;display:flex;gap:8px"><button class="btn btn-primary view" data-id="${escapeHtml(p.id||'')}">View</button><button class="btn btn-outline msg" data-id="${escapeHtml(p.id||'')}">Message</button></div>`;
        wrap.appendChild(el);
      });
      wrap.querySelectorAll('.msg').forEach(b=>b.addEventListener('click',e=>openPrivateChat(e.currentTarget.dataset.id)));
      wrap.querySelectorAll('.view').forEach(b=>b.addEventListener('click',e=>openProfile(e.currentTarget.dataset.id)));
    }

    function renderGlobalFeed(){
      const wrap=$('globalFeed'); if(!wrap) return; wrap.innerHTML='';
      const list = (CHATS && CHATS.global) ? CHATS.global.slice().reverse() : [];
      list.forEach(p=>{
        const el=document.createElement('div'); el.className='card';
        el.innerHTML=`<div style="font-weight:700">${escapeHtml(p.user)} <span class="small" style="margin-left:8px">${escapeHtml(p.time||'')}</span></div><div class="small" style="margin-top:6px">${escapeHtml(p.txt||'')}</div>`;
        if(p.location){
          const btnWrap=document.createElement('div'); btnWrap.style.marginTop='8px';
          const btn=document.createElement('button'); btn.className='btn-outline show-loc';
          const lat=p.location.lat || (Array.isArray(p.location)?p.location[0]:'');
          const lng=p.location.lng || (Array.isArray(p.location)?p.location[1]:'');
          btn.dataset.lat=lat; btn.dataset.lng=lng; btn.dataset.user=p.user; btn.textContent='Mostra posizione & Apri chat';
          btn.addEventListener('click',()=>{ const latn=parseFloat(btn.dataset.lat); const lngn=parseFloat(btn.dataset.lng); showLocationOnMap([latn,lngn]); const prof=PROFILES.find(pr=>pr.name===btn.dataset.user); const pid=prof?prof.id:btn.dataset.user; openPrivateChat(pid); });
          btnWrap.appendChild(btn); el.appendChild(btnWrap);
        }
        wrap.appendChild(el);
      });
    }

    function populateQuickFilters(){ const citySel=$('quickCity'); if(!citySel) return; citySel.innerHTML='<option value="">Tutte le città</option>'; const cities=Array.from(new Set((STRUCTURES||[]).map(s=>s.citta).filter(Boolean))).sort(); cities.forEach(c=>{ const o=document.createElement('option'); o.value=c; o.textContent=c; citySel.appendChild(o); }); }

    function populateQuickList(){
      const sel=$('quickStructure'), resultsWrap=$('quickResults'); if(!sel||!resultsWrap) return; sel.innerHTML=''; resultsWrap.innerHTML='';
      if(!quickSearchPerformed){ const o=document.createElement('option'); o.value=''; o.textContent='Premi "Cerca" per mostrare le strutture'; sel.appendChild(o); if($('quickSearchNote')) $('quickSearchNote').textContent='Filtra e premi "Cerca".'; return; }
      const city = $('quickCity')?$('quickCity').value:''; const type=$('quickType')?$('quickType').value:''; const priceFilter=$('quickPriceFilter')?$('quickPriceFilter').value:'';
      const filtered=(STRUCTURES||[]).filter(s=>{ if(city && s.citta!==city) return false; if(type && s.tipo!==type) return false; if(priceFilter){ if(priceFilter==='cheap' && !(s.prezzo_da<20)) return false; if(priceFilter==='budget' && !(s.prezzo_da>=20 && s.prezzo_da<=40)) return false; if(priceFilter==='premium' && !(s.prezzo_da>40)) return false; } return true; });
      if(!filtered.length){ const o=document.createElement('option'); o.value=''; o.textContent='Nessuna struttura con questi filtri'; sel.appendChild(o); if($('quickSearchNote')) $('quickSearchNote').textContent='Riprova con filtri diversi.'; resultsWrap.innerHTML=`<div class="note">Nessun risultato</div>`; return; }
      filtered.forEach(s=>{ const o=document.createElement('option'); o.value=s.id; o.textContent=`${s.nome} — ${s.citta} — ${s.tipo} — da ${s.prezzo_da}€`; sel.appendChild(o); const card=document.createElement('div'); card.className='result-card'; card.innerHTML=`<div style="font-weight:700">${escapeHtml(s.nome)}</div><div class="small" style="margin-top:6px">${escapeHtml(s.citta)} • ${escapeHtml(s.tipo)} • da ${escapeHtml(String(s.prezzo_da))}€</div><div style="margin-top:8px;display:flex;gap:8px"><button class="btn-primary btn-select" data-id="${escapeHtml(s.id)}">Seleziona</button><button class="btn-outline btn-open" data-id="${escapeHtml(s.id)}">Apri</button></div>`; resultsWrap.appendChild(card); });
      resultsWrap.querySelectorAll('.btn-select').forEach(b=>b.addEventListener('click',e=>{ const id=e.currentTarget.dataset.id; if($('quickStructure')) $('quickStructure').value=id; if($('quickSearchNote')) $('quickSearchNote').textContent='Hai selezionato una struttura.'; }));
      resultsWrap.querySelectorAll('.btn-open').forEach(b=>b.addEventListener('click',e=>{ const id=e.currentTarget.dataset.id; const it=(STRUCTURES||[]).find(x=>x.id===id); if(it) openBookingModal(it); }));
      if($('quickSearchNote')) $('quickSearchNote').textContent=`${(STRUCTURES||[]).filter(s=>s).length} risultato(i) trovato(i).`;
    }

    // Geocoding & routing helpers (Nominatim + OSRM)
    async function geocodeSafe(query){
      if(!query) return null;
      try{
        const url = 'https://nominatim.openstreetmap.org/search?format=geojson&q='+encodeURIComponent(query)+'&limit=1&countrycodes=it';
        const r = await fetch(url,{headers:{'Accept':'application/json'}});
        if(!r.ok) return null;
        const data = await r.json();
        if(!data || !data.features || !data.features.length) return null;
        const f = data.features[0]; const c = f.geometry.coordinates; const props = f.properties||{};
        return { coords:[c[1],c[0]], name: props.display_name || query, country_code: (props.country_code||'').toLowerCase() };
      }catch(e){ console.warn('Nominatim error', e); return null; }
    }

    async function fetchOsrmRoute(profile, fromCoords, toCoords, includeSteps=false){
      try{
        const lon1=fromCoords[1], lat1=fromCoords[0], lon2=toCoords[1], lat2=toCoords[0];
        const params = new URLSearchParams({ overview:'full', geometries:'geojson' });
        if(includeSteps) params.set('steps','true');
        const url = `https://router.project-osrm.org/route/v1/${profile}/${lon1},${lat1};${lon2},${lat2}?`+params.toString();
        const r = await fetch(url);
        if(!r.ok) throw new Error('OSRM '+r.status);
        const data = await r.json();
        if(!data.routes || !data.routes.length) return null;
        return data.routes[0];
      }catch(e){ console.warn('OSRM fetch error', e); return null; }
    }

    function renderRoute(route, fromCoords, toCoords, mode, opts={}){
      try{
        if(!map) initMap();
        if(routeLayer){ try{ map.removeLayer(routeLayer); }catch(e){} routeLayer=null; }
        const coords = route.geometry.coordinates.map(c=>[c[1],c[0]]);
        let style = { color:'#FF6B35', weight:6, opacity:0.95 };
        if(mode==='cycling-regular') style = { color:'#2EC44E', weight:6, opacity:0.95 };
        if(mode==='foot-walking') style = { color:'#f39c12', weight:5, opacity:0.95, dashArray:'4,8' };
        if(mode==='public-transport') style = { color:'#7b5cff', weight:5, opacity:0.9, dashArray:'8,8' };
        const line = L.polyline(coords, style);
        const fromMarker = L.circleMarker(fromCoords,{ radius:6, color:'#045', fillColor:style.color, fillOpacity:1 });
        const toMarker = L.circleMarker(toCoords,{ radius:6, color:'#045', fillColor:'#3db9ff', fillOpacity:1 });
        routeLayer = L.layerGroup([line, fromMarker, toMarker]).addTo(map);
        try{ map.fitBounds(line.getBounds().pad(0.1)); }catch(e){}
        if(opts.alternativeRoute){
          const altCoords = opts.alternativeRoute.geometry.coordinates.map(c=>[c[1],c[0]]);
          L.polyline(altCoords,{color:'#888',weight:4,dashArray:'6,8',opacity:0.7}).addTo(map);
        }
      }catch(e){ console.error('renderRoute error', e); }
    }

    async function calculateRoute(){
      const fromEl=$('from'), toEl=$('to'), routeInfo=$('routeInfo');
      const aQ = fromEl?fromEl.value.trim():''; const bQ = toEl?toEl.value.trim():'';
      if(!aQ||!bQ){ if(routeInfo) routeInfo.textContent='Inserisci partenza e arrivo'; return; }
      try{
        if(routeInfo) routeInfo.textContent='Localizzo...';
        const [aObj,bObj] = await Promise.all([geocodeSafe(aQ), geocodeSafe(bQ)]);
        if(!aObj||!bObj){ if(routeInfo) routeInfo.textContent='Località non trovate'; return; }
        if(!confirm(`Confermi Partenza: ${aObj.name}\nDestinazione: ${bObj.name}\nOK per calcolare?`)){ if(routeInfo) routeInfo.textContent='Calcolo annullato'; return; }
        if(routeInfo) routeInfo.textContent='Calcolo percorso...';
        const modeVal = $('mode')?$('mode').value:'driving-car';
        const profileMap = {'driving-car':'driving','cycling-regular':'cycling','foot-walking':'walking'};
        const profile = profileMap[modeVal] || 'driving';
        const route = await fetchOsrmRoute(profile, aObj.coords, bObj.coords, true);
        if(!route){ if(routeInfo) routeInfo.textContent='Nessun percorso trovato'; return; }
        if(typeof renderRoute==='function'){ renderRoute(route,aObj.coords,bObj.coords,modeVal); if(routeInfo) routeInfo.textContent=`${(route.distance/1000).toFixed(1)} km • ${Math.round(route.duration/60)} min (${modeVal})`; }
        else { initMap(); try{ map.setView(aObj.coords,10);}catch(e){} if(routeInfo) routeInfo.textContent='Percorso calcolato (vista mappa).'; }
      }catch(e){ console.error('calculateRoute error', e); if(routeInfo) routeInfo.textContent='Errore nel calcolo percorso'; }
    }

    /* ---------- Groups/chat/posts/booking implementations (patched for storage) ---------- */
    function renderGroups(){ const wrap=$('groupsList'); if(!wrap) return; wrap.innerHTML=''; const city=$('filterCity')?$('filterCity').value:''; const list = GROUPS.filter(g=>!city||g.city===city); if(!list.length){ wrap.innerHTML='<div class="small">Nessun gruppo</div>'; return; } list.forEach(g=>{ const el=document.createElement('div'); el.className='card'; el.style.display='flex'; el.style.justifyContent='space-between'; el.style.alignItems='center'; el.innerHTML=`<div><div style="font-weight:700">${escapeHtml(g.name)}</div><div class="small">${escapeHtml(g.city)} · ${escapeHtml(g.desc||'')}</div></div>`; const actions=document.createElement('div'); const openBtn=document.createElement('button'); openBtn.className='btn btn-primary'; openBtn.textContent='Apri'; openBtn.addEventListener('click',()=>{ openGroup(g.id); setActiveChat({type:'group',id:g.id}); }); const joinBtn=document.createElement('button'); joinBtn.className='btn btn-outline'; joinBtn.textContent = isMember(g.id)? 'Membro' : 'Iscriviti'; joinBtn.addEventListener('click',()=>toggleMembership(g.id)); actions.appendChild(openBtn); actions.appendChild(joinBtn); el.appendChild(actions); wrap.appendChild(el); }); }

    function populateFilterCities(){ const sel=$('filterCity'); if(!sel) return; sel.innerHTML='<option value="">Tutte le città</option>'; const cities=Array.from(new Set(GROUPS.map(g=>g.city).filter(Boolean))).sort(); cities.forEach(c=>{ const o=document.createElement('option'); o.value=c; o.textContent=c; sel.appendChild(o); }); }

    function isMember(gid){ GROUP_MEMBERS[gid]=GROUP_MEMBERS[gid]||{}; return !!GROUP_MEMBERS[gid][ME.id]; }
    function toggleMembership(gid){ GROUP_MEMBERS[gid]=GROUP_MEMBERS[gid]||{}; if(GROUP_MEMBERS[gid][ME.id]) delete GROUP_MEMBERS[gid][ME.id]; else GROUP_MEMBERS[gid][ME.id]=true; save(K_GROUP_MEMBERS,GROUP_MEMBERS); if(window.sb) supabaseInsert(K_GROUP_MEMBERS,{group_id:gid,member_id:ME.id,is_member:!!GROUP_MEMBERS[gid][ME.id],updated_at:new Date().toISOString()}); renderGroups(); if(selectedGroup===gid) updateJoinButtons(); }
    function createGroup(){ const name=$('gName')?.value.trim(), city=$('gCity')?.value.trim(), desc=$('gDesc')?.value.trim(); if(!name||!city) return alert('Nome e città obbligatori'); const id=uid('g'); GROUPS.push({id,name,city,desc}); GROUP_MEMBERS[id]={}; GROUP_MEMBERS[id][ME.id]=true; save(K_GROUPS,GROUPS); save(K_GROUP_MEMBERS,GROUP_MEMBERS); if(window.sb) supabaseInsert(K_GROUPS,{id,name,city,"desc":desc,created_at:new Date().toISOString()}); hideModal('modalGroup'); populateFilterCities(); renderGroups(); openGroup(id); if($('gName')) $('gName').value=''; if($('gCity')) $('gCity').value=''; if($('gDesc')) $('gDesc').value=''; }

    function openGroup(id){ selectedGroup=id; const g=GROUPS.find(x=>x.id===id); if($('centerTitle')) $('centerTitle').textContent = g? `Gruppo: ${g.name}` : 'Gruppo'; if($('centerSubtitle')) $('centerSubtitle').textContent = g? `${g.city} · ${g.desc||''}` : ''; renderActiveChat(); updateJoinButtons(); }
    function updateJoinButtons(){ const joined = selectedGroup && isMember(selectedGroup); if($('btnJoin')) $('btnJoin').style.display = (!joined && selectedGroup) ? 'inline-block' : 'none'; if($('btnLeave')) $('btnLeave').style.display = (joined && selectedGroup) ? 'inline-block' : 'none'; }
    function joinGroup(){ if(!selectedGroup) return; GROUP_MEMBERS[selectedGroup]=GROUP_MEMBERS[selectedGroup]||{}; GROUP_MEMBERS[selectedGroup][ME.id]=true; save(K_GROUP_MEMBERS,GROUP_MEMBERS); if(window.sb) supabaseInsert(K_GROUP_MEMBERS,{group_id:selectedGroup,member_id:ME.id,is_member:true,created_at:new Date().toISOString()}); updateJoinButtons(); renderGroups(); }
    function leaveGroup(){ if(!selectedGroup) return; delete GROUP_MEMBERS[selectedGroup][ME.id]; save(K_GROUP_MEMBERS,GROUP_MEMBERS); if(window.sb) supabaseInsert(K_GROUP_MEMBERS,{group_id:selectedGroup,member_id:ME.id,is_member:false,updated_at:new Date().toISOString()}); updateJoinButtons(); renderGroups(); }

    // Chat render/send
    function chatKeyForActive(){ if(activeChat.type==='global') return 'global'; if(activeChat.type==='group') return 'group:'+(activeChat.id||''); if(activeChat.type==='private') return 'private:'+(activeChat.id||''); return 'global'; }
    function renderActiveChat(){ const win=$('groupChat'); if(!win) return; win.innerHTML=''; const key=chatKeyForActive(); CHATS[key]=CHATS[key]||[]; CHATS[key].forEach(m=>{ const d=document.createElement('div'); d.className='msg '+(m.user===ME.name?'me':''); const userBtn=document.createElement('button'); userBtn.className='user-link'; userBtn.type='button'; userBtn.textContent=m.user; userBtn.addEventListener('click',()=>openProfileByName(m.user)); const header=document.createElement('div'); header.style.fontWeight='700'; header.appendChild(userBtn); const timeSpan=document.createElement('span'); timeSpan.className='small'; timeSpan.style.marginLeft='8px'; timeSpan.textContent=m.time||''; header.appendChild(timeSpan); d.appendChild(header); const body=document.createElement('div'); body.style.marginTop='6px'; if(m.txt) body.appendChild(document.createTextNode(m.txt)); if(m.file && m.file.url){ const type=(m.file.type||'').toLowerCase(); const name=(m.file.name||'').toLowerCase(); const isImage = type.startsWith('image') || /\.(jpe?g|png|gif|webp|bmp)$/i.test(name); const isVideo = type.startsWith('video') || /\.(mp4|webm|ogg|mov)$/i.test(name); if(isImage){ const img=document.createElement('img'); img.src=m.file.url; img.className='chat-media'; img.style.maxWidth='420px'; body.appendChild(img);} else if(isVideo){ const vid=document.createElement('video'); vid.src=m.file.url; vid.controls=true; vid.className='chat-video'; vid.style.maxWidth='420px'; body.appendChild(vid);} else { const a=document.createElement('a'); a.href=m.file.url; a.textContent=m.file.name||'File'; a.target='_blank'; a.rel='noopener noreferrer'; a.className='small'; body.appendChild(document.createElement('br')); body.appendChild(a);} } if(m.location){ const locBtn=document.createElement('button'); locBtn.className='btn-outline'; locBtn.style.marginTop='8px'; locBtn.textContent='Mostra sulla mappa'; locBtn.addEventListener('click',()=>{ showLocationOnMap(m.location); if(m.user && m.user!==ME.name){ const prof=PROFILES.find(p=>p.name===m.user); const pid=prof?prof.id:m.user; openPrivateChat(pid); setActiveChat({type:'private',id:pid}); } }); body.appendChild(locBtn); } d.appendChild(body); win.appendChild(d); }); win.scrollTop = win.scrollHeight; }

    async function sendChat(){ const text=$('chatInput')?.value.trim(); if(!text) return; const key=chatKeyForActive(); CHATS[key]=CHATS[key]||[]; const post={user:ME.name,txt:text,time:now()}; CHATS[key].push(post); save(K_CHATS,CHATS); if(window.sb){ const payloadSafe=safeForInsert(post); await supabaseInsert('smn_chats_v1',{ chat_key:key, payload:payloadSafe, created_at: new Date().toISOString() }); } if($('chatInput')) $('chatInput').value=''; renderActiveChat(); if(activeChat.type==='group' || activeChat.type==='global') botReply(key,text); }

    function botReply(key,userMsg){ const list=CHATS[key]||[]; const last=list.length?list[list.length-1]:null; if(last && last.user==='SMN Bot') return; setTimeout(()=>{ const lower=(userMsg||'').toLowerCase(); let reply="Grazie! Ti rispondo presto."; if(lower.includes('prenot')) reply="Per prenotare usa il pannello a destra e premi 'Cerca'."; else if(lower.includes('ciao')||lower.includes('salve')) reply="Ciao! Come possiamo aiutarti oggi?"; else { const foundCity = Object.keys(CITY_INFO).find(c=>lower.includes(c.toLowerCase())); if(foundCity){ const info=CITY_INFO[foundCity]; reply=`A ${foundCity} ci sono ~${info.nomads} nomadi. Evento: ${info.event.title} il ${info.event.date}.`; } else reply="Ottimo post — prova a condividere posizione o allegare una foto."; } const botPost={user:'SMN Bot',txt:reply,time:now()}; CHATS[key]=CHATS[key]||[]; CHATS[key].push(botPost); save(K_CHATS,CHATS); if(window.sb){ const payloadSafe=safeForInsert(botPost); supabaseInsert('smn_chats_v1',{ chat_key:key, payload: payloadSafe, created_at: new Date().toISOString() }); } renderActiveChat(); },800+Math.random()*600); }

    // Posts & uploads (patched: upload to storage)
    function attachPosition(){ const btn=$('postAttachPos'); if(btn){ btn.disabled=true; btn.textContent='Recupero...'; } navigator.geolocation.getCurrentPosition(pos=>{ pendingPos={lat:pos.coords.latitude,lng:pos.coords.longitude}; if($('postInfo')) $('postInfo').textContent=`Posizione allegata: ${pendingPos.lat.toFixed(4)}, ${pendingPos.lng.toFixed(4)}`; if(btn){ btn.disabled=false; btn.textContent='Allega posizione'; } }, err=>{ alert('Errore posizione: ' + (err.message || '')); if(btn){ btn.disabled=false; btn.textContent='Allega posizione'; } }, {timeout:8000}); }

    // publishPost now uploads files to Supabase Storage when available
    async function publishPost(){
      let targetKey;
      if(activeChat && activeChat.type==='group' && activeChat.id) targetKey='group:'+activeChat.id;
      else if(activeChat && activeChat.type==='private' && activeChat.id) targetKey='private:'+activeChat.id;
      else if(activeChat && activeChat.type==='global') targetKey='global';
      else if(selectedGroup) targetKey='group:'+selectedGroup;
      else targetKey='global';

      if(targetKey.startsWith('group:')){ const gid=targetKey.split(':')[1]; if(!isMember(gid)) return alert('Devi iscriverti al gruppo per postare'); }

      const text=$('postText')?.value.trim();
      if(!text && !pendingFile && !pendingPos) return alert('Testo, file o posizione richiesti');

      const post={user:ME.name,txt:text,time:now(),file:null,location:null};

      if(pendingFile){
        // If Supabase storage is available, upload; otherwise keep local FileReader fallback (dataURL)
        if(window.sb && window.sb.storage){
          try{
            const uploaded = await uploadFileToStorage(pendingFile);
            let url = uploaded.url;
            if(!url){
              // try to get public url (maybe bucket private)
              url = await getFilePublicUrl(uploaded.path);
            }
            post.file = { name: pendingFile.name, url: url || '', type: pendingFile.type || '', storage_path: uploaded.path };
          }catch(err){
            console.error('Upload fallito', err);
            alert('Upload fallito: ' + (err.message || 'errore'));
            pendingFile = null;
            if($('postFile')) $('postFile').value = '';
            return;
          }
        } else {
          // fallback: read as dataURL (for demo only). Warning: not scalable.
          const fileObj = pendingFile;
          const reader = new FileReader();
          const p = await new Promise((resolve,reject)=>{
            reader.onload = ()=> resolve({ url: reader.result });
            reader.onerror = (e) => reject(e);
            reader.readAsDataURL(fileObj);
          }).catch(e=>{ console.error('FileReader failed:', e); alert('Impossibile leggere il file selezionato.'); });
          if(p && p.url) post.file = { name: fileObj.name, url: p.url, type: fileObj.type||'' };
        }
        pendingFile = null;
        if($('postFile')) $('postFile').value='';
      } else {
        if(pendingPos) post.location = {...pendingPos};
      }

      finalizePost(targetKey,post);
    }

    async function finalizePost(targetKey,post){
      CHATS[targetKey]=CHATS[targetKey]||[]; CHATS[targetKey].push(post); save(K_CHATS,CHATS);

      if(post.location){
        const upl = { id: uid('u'), name:(selectedGroup? 'Gruppo:'+selectedGroup:ME.name), location: Array.isArray(post.location)?post.location:[post.location.lat,post.location.lng], sharerName:ME.name, time: now() };
        UPLOADS.push(upl); save(K_UPLOADS,UPLOADS);
        if(window.sb) await supabaseInsert('smn_uploads_v1', { id: upl.id, payload: upl, created_at: new Date().toISOString() });
        if(map) addUploadMarker(upl);
      }

      let pushedToGlobal=false;
      if((post.file||post.location) && targetKey!=='global'){
        const globalCopy={ user:ME.name, txt:(post.txt||''), time:now(), file:post.file?post.file:null, location:post.location?post.location:null };
        CHATS.global=CHATS.global||[]; CHATS.global.push(globalCopy); save(K_CHATS,CHATS);
        if(window.sb) await supabaseInsert('smn_chats_v1',{ chat_key:'global', payload: safeForInsert(globalCopy), created_at: new Date().toISOString() });
        renderGlobalFeed(); pushedToGlobal=true;
      }
      if($('postCross') && $('postCross').checked && !pushedToGlobal){
        CHATS.global=CHATS.global||[]; const gText=(selectedGroup&&getGroupById(selectedGroup))?`[${getGroupById(selectedGroup).name}] ${post.txt||''}`:(post.txt||''); const gPost={user:ME.name,txt:gText,time:now(),file:post.file?post.file:null,location:post.location?post.location:null}; CHATS.global.push(gPost); save(K_CHATS,CHATS);
        if(window.sb) await supabaseInsert('smn_chats_v1',{ chat_key:'global', payload: safeForInsert(gPost), created_at: new Date().toISOString() });
        renderGlobalFeed();
      }

      if(window.sb) await supabaseInsert('smn_chats_v1', { chat_key: targetKey, payload: safeForInsert(post), created_at: new Date().toISOString() });
      renderActiveChat(); if(targetKey==='global') renderGlobalFeed();
      pendingPos=null; if($('postText')) $('postText').value=''; if($('postInfo')) $('postInfo').textContent='Pubblicato'; if(targetKey.startsWith('group:')||targetKey==='global') botReply(targetKey,post.txt||'');
    }

    function getGroupById(id){ return GROUPS.find(g=>g.id===id); }

    /* Map helpers */
    function initMap(){ if(map) return; map=L.map('map').setView([43.7,12.7],6.2); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:18}).addTo(map); markersLayer=L.layerGroup().addTo(map); Object.keys(CITY_COORDS).forEach(city=>{ const coords=CITY_COORDS[city]; const marker=L.marker(coords).addTo(markersLayer); marker.bindPopup(`<b>${escapeHtml(city)}</b>`,{minWidth:200}); }); UPLOADS.forEach(u=>{ if(u.location && Array.isArray(u.location)) addUploadMarker(u); }); }
    function addUploadMarker(u){ if(!map) return; try{ const coords=Array.isArray(u.location)?u.location:[u.location.lat,u.location.lng]; if(!coords||coords.length!==2) return; const m=L.marker(coords).addTo(markersLayer); m.bindPopup(`<div style="font-weight:700">${escapeHtml(u.sharerName||u.name||'Condiviso')}</div><div class="small">${escapeHtml(u.time||'')}</div>`); }catch(e){console.warn(e);} }
    function showLocationOnMap(location){ initMap(); const coords=Array.isArray(location)?location:[location.lat,location.lng]; if(!coords||coords.length!==2) return; if(highlightMarker){ try{ markersLayer.removeLayer(highlightMarker);}catch(e){} highlightMarker=null;} highlightMarker=L.circleMarker(coords,{radius:10,color:'#ff4d6d',weight:3,fillColor:'#ff9aa2',fillOpacity:0.6}).addTo(markersLayer); map.setView(coords,13,{animate:true}); if(highlightTimeout) clearTimeout(highlightTimeout); highlightTimeout=setTimeout(()=>{ if(highlightMarker){ try{ markersLayer.removeLayer(highlightMarker);}catch(e){} highlightMarker=null;} },8000); }

    /* Booking */
    function openBookingModal(item,preDate='',preName=''){ if(!item) return alert('Struttura non trovata'); bookingCandidate=item; const pre = preDate||$('quickDate')?.value; const pname = preName||$('quickName')?.value.trim(); const proceed = confirm(`Confermi prenotazione per ${item.nome} il ${pre} a nome ${pname}?`); if(proceed){ const id='BK-'+Math.random().toString(36).slice(2,8).toUpperCase(); BOOKS.push({id,structureId:item.id,structureName:item.nome,date:pre,name:pname,city:item.citta,type:item.tipo,created:Date.now()}); save(K_BOOKS,BOOKS); if(window.sb) supabaseInsert(K_BOOKS,{ id:id, structure_id:item.id, structure_name:item.nome, date:pre, name:pname, city:item.citta, type:item.tipo, created_at:new Date().toISOString() }); if($('bookings')) $('bookings').textContent = BOOKS.length?`${BOOKS.length} prenotazione/i (demo)`: 'Nessuna prenotazione'; CHATS.global=CHATS.global||[]; const bookingMsg={user:ME.name,txt:`Prenotazione confermata: ${item.nome} - ${pre} (ID ${id})`,time:now(),type:'booking'}; CHATS.global.push(bookingMsg); save(K_CHATS,CHATS); if(window.sb) supabaseInsert('smn_chats_v1',{ chat_key:'global', payload: safeForInsert(bookingMsg), created_at: new Date().toISOString() }); renderGlobalFeed(); alert('Prenotazione demo: '+id); } }

    /* Misc helpers */
    function renderPremiumUI(){ const acc=$('accountBox'); if(!acc) return; if((PREMIUM && PREMIUM.active)) acc.innerHTML = `Account: ${escapeHtml(ME.name)} <span style="background:linear-gradient(90deg,#ffd166,#ff7b7b);padding:4px 8px;border-radius:999px;font-weight:700;font-size:.8rem;margin-left:8px">PREMIUM</span>`; else acc.textContent=`Account: ${ME.name}`; }
    function openProfile(id){ const p=PROFILES.find(x=>x.id===id); if(!p) return alert('Profilo non trovato'); alert(`${p.name}\n${p.job}\n${p.city}\n\n${p.bio}`); }
    function openProfileByName(name){ const p=PROFILES.find(x=>x.name===name); if(p) openProfile(p.id); else alert('Profilo non trovato'); }
    function openPrivateChat(profileIdOrName){ let pid=profileIdOrName; const found=PROFILES.find(p=>p.id===profileIdOrName||p.name===profileIdOrName); if(found) pid=found.id; const key='private:'+pid; CHATS[key]=CHATS[key]||[]; if(!CHATS[key].length && found){ const greeting={user:found.name,txt:'Ciao! Sono '+found.name,time:now()}; CHATS[key].push(greeting); save(K_CHATS,CHATS); if(window.sb) supabaseInsert('smn_chats_v1',{ chat_key:key, payload:safeForInsert(greeting), created_at: new Date().toISOString() }); } setActiveChat({type:'private',id:pid}); }

    /* ---------- Event binding ---------- */
    function bind(){
      $('btnNewGroup')?.addEventListener('click',()=>showModal('modalGroup'));
      $('gCancel')?.addEventListener('click',()=>hideModal('modalGroup'));
      $('gSave')?.addEventListener('click',()=>createGroup());
      $('filterCity')?.addEventListener('change',()=>renderGroups());
      $('chatSend')?.addEventListener('click',()=>sendChat());
      $('chatInput')?.addEventListener('keypress',e=>{ if(e.key==='Enter') sendChat(); });
      $('btnSwitchGlobal')?.addEventListener('click',()=>setActiveChat({type:'global',id:null}));
      $('postFile')?.addEventListener('change',e=>{ pendingFile = e.target.files && e.target.files[0]; if($('postInfo')) $('postInfo').textContent = pendingFile ? `${pendingFile.name} allegato` : ''; });
      $('postAttachPos')?.addEventListener('click',()=>attachPosition());
      $('postPublish')?.addEventListener('click',()=>publishPost());
      $('btnOpenMap')?.addEventListener('click',()=>{ initMap(); setTimeout(()=> map.invalidateSize(),200); });
      $('btnRoute')?.addEventListener('click',()=>calculateRoute());
      $('quickSearch')?.addEventListener('click',()=>{ quickSearchPerformed=true; populateQuickList(); });
      ['quickCity','quickType','quickPriceFilter'].forEach(id=>{ const el=$(id); if(el) el.addEventListener('keypress',e=>{ if(e.key==='Enter'){ quickSearchPerformed=true; populateQuickList(); } }); });
      $('quickBook')?.addEventListener('click',()=>openBookingModal(STRUCTURES.find(s=>s.id==$('quickStructure')?.value), $('quickDate')?.value, $('quickName')?.value));
      $('btnJoin')?.addEventListener('click',()=>joinGroup());
      $('btnLeave')?.addEventListener('click',()=>leaveGroup());
      $('btnSubscribe')?.addEventListener('click',()=>{ PREMIUM.active=true; save(K_PREMIUM,PREMIUM); renderPremiumUI(); alert('Pagamento simulato — sei Premium (demo)'); });
      // Optional: Install button
      const btnInstall = $('btnInstall');
      if(btnInstall){
        btnInstall.addEventListener('click', async ()=>{
          if(window.deferredPWAInstall){
            try{
              window.deferredPWAInstall.prompt();
              const choice = await window.deferredPWAInstall.userChoice;
              console.log('PWA install choice', choice);
            }catch(e){ console.warn('PWA install prompt failed', e); }
            btnInstall.style.display='none';
            window.deferredPWAInstall = null;
          }
        });
      }
    }

    /* ---------- Pull from Supabase (best-effort) ---------- */
    async function pullFromSupabase(){
      if(!window.sb) return;
      try{
        const [g,p,u,c,b] = await Promise.all([
          supabaseSelect('smn_groups_v1'),
          supabaseSelect('smn_profiles_v1'),
          supabaseSelect('smn_uploads_v1'),
          supabaseSelect('smn_chats_v1'),
          supabaseSelect('smn_books_v1')
        ]);
        if(Array.isArray(g) && g.length){ GROUPS = g.map(x=>({ id: x.id || uid('g'), name: x.name||'', city: x.city||'', desc: x["desc"]||'' })); save(K_GROUPS,GROUPS); }
        if(Array.isArray(p) && p.length){ PROFILES = p.map(x=>({ id: x.id||uid('p'), name:x.name||'', job:x.job||'', city:x.city||'', bio:x.bio||'' })); save(K_PROFILES,PROFILES); }
        if(Array.isArray(u) && u.length){ try{ UPLOADS = u.map(r=> r.payload || r); save(K_UPLOADS,UPLOADS);}catch(e){} }
        if(Array.isArray(c) && c.length){ const grouped={}; c.forEach(rec=>{ const key = rec.chat_key||'global'; grouped[key]=grouped[key]||[]; grouped[key].push(rec.payload||rec); }); CHATS = Object.assign({}, load(K_CHATS,{}), grouped); save(K_CHATS,CHATS); }
        if(Array.isArray(b) && b.length){ BOOKS = b.map(x=>({ id:x.id||uid('bk'), structureId:x.structure_id||'', structureName:x.structure_name||'', date:x.date||'', name:x.name||'', city:x.city||'', type:x.type||'' })); save(K_BOOKS,BOOKS); }
        console.info('Pulled data from Supabase (best-effort)');
      }catch(e){ console.warn('pullFromSupabase error',e); }
    }

    /* ---------- Boot ---------- */
    async function boot(){
      bind();
      populateFilterCities();
      renderGroups();
      renderProfiles();
      renderGlobalFeed();
      populateQuickFilters();
      populateQuickList();
      if(window.sb) await pullFromSupabase();
      if(GROUPS.length) selectedGroup = GROUPS[0].id;
      if($('bookings')) $('bookings').textContent = BOOKS.length ? `${BOOKS.length} prenotazione/i (demo)` : 'Nessuna prenotazione';
      renderPremiumUI();
      setActiveChat({type:'global',id:null});
      initMap();
      console.info('Demo ready (Supabase ' + (window.sb ? 'ENABLED' : 'DISABLED') + ')');
      window.smnDebug = ()=>({ GROUPS, GROUP_MEMBERS, CHATS, UPLOADS, PROFILES, BOOKS, PREMIUM, FOLLOWS, CITY_INFO, STRUCTURES, activeChat, selectedGroup, quickSearchPerformed });
    }

    boot();

  })();
  </script>

  <!-- Service worker / PWA install + online/offline handling -->
  <script>
    // online/offline UI
    function updateOnlineStatus(){
      const banner = document.getElementById('offlineBanner');
      if(!banner) return;
      if(navigator.onLine) banner.style.display = 'none';
      else banner.style.display = 'block';
    }
    window.addEventListener('online', updateOnlineStatus);
    window.addEventListener('offline', updateOnlineStatus);
    updateOnlineStatus();

    // beforeinstallprompt: capture to show custom install button
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      window.deferredPWAInstall = e;
      const btn = document.getElementById('btnInstall');
      if(btn) btn.style.display = 'inline-block';
    });

    // register service worker if available
    if('serviceWorker' in navigator){
      navigator.serviceWorker.register('/sw.js')
        .then(reg => {
          console.log('ServiceWorker registered:', reg);
        })
        .catch(err => {
          console.warn('ServiceWorker registration failed:', err);
        });
    }
  </script>
</body>
</html>